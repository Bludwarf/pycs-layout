/*
 * Pycs-Layout jquery plugin
 * @author: Antoine de Monte
 *
 * Free to use under the MIT license.
 * http://www.opensource.org/licenses/mit-license.php
 *  
 * This algorithm optimizes the distribution
 * of pictures inside their container.
 *
 * Thanks Johannes Treitz for this one.
 * http://www.crispymtn.com/stories/the-algorithm-for-a-perfectly-balanced-photo-gallery
*/
(function(a){a.fn.pycsLayout=function(b){var d=a.extend({pictureContainer:".picture",idealHeight:150,gutter:6,},b);var c=function(v,t){var u=function(D,z){var C=[];for(var B=0;B<D;B++){C[B]=[];for(var A=0;A<z;A++){C[B][A]=0}}return C};var r=function(I,B){n=I.length;if(B<=0){return[]}if(B>n){return I.map(function(i){return[i]})}var H=u(n,B);var E=u(n,B);for(var D=0;D<n;D++){H[D][0]=I[D];if(D>0){H[D][0]+=H[D-1][0]}}for(var C=0;C<B;C++){H[0][C]=I[0]}for(var D=1;D<n;D++){for(var C=1;C<B;C++){var A=[Math.max(H[0][C-1],H[D][0]-H[0][0])];A.push(0);for(var G=0;G<D;G++){var F=Math.max(H[G][C-1],H[D][0]-H[G][0]);if(F<A[0]){A=[F,G]}}H[D][C]=A[0];E[D-1][C-1]=A[1]}}n=n-1;B=B-2;ans=[];while(B>=0){var z=[];if(n>0){for(var D=E[n-1][B]+1;D<n+1;D++){z.push(I[D])}ans=[z].concat(ans);n=E[n-1][B]}B=B-1}var z=[];for(var D=0;D<n+1;D++){z.push(I[D])}return[z].concat(ans)};var k=function(B){aspect_ratios=[];for(var C=0;C<B.length;C++){var D=parseInt(a(B[C]).attr("data-pycs-width"));var j=parseInt(a(B[C]).attr("data-pycs-height"));var A=D/j;var z=A*d.idealHeight;a(B[C]).attr("data-pycs-vwidth",z);a(B[C]).attr("data-pycs-vheight",d.idealHeight);a(B[C]).attr("data-pycs-aspect-ratio",A);aspect_ratios.push(parseInt(A*100))}return aspect_ratios};var o=0;var w=k(t);var p=0;var y=[];for(var m=0;m<t.length;m++){o+=(parseInt(a(t[m]).attr("data-pycs-vwidth"))+d.gutter)}p=Math.round(o/v);if(p==0){partition=[w]}else{partition=r(w,p)}var q=0;for(var m=0;m<partition.length;m++){y[m]=[];var s=0;for(var l=0;l<partition[m].length;l++){s+=parseFloat(a(t[q]).attr("data-pycs-aspect-ratio"));y[m][l]=t[q];q++}for(var l=0;l<y[m].length;l++){var h=v/s;h*=parseFloat(a(y[m][l]).attr("data-pycs-aspect-ratio"));h=parseInt(h)-(d.gutter);var x=parseInt(((v-y[m].length*d.gutter)/s));a(y[m][l]).attr("data-pycs-vwidth",h);a(y[m][l]).attr("data-pycs-vheight",x)}}return y};var f=function(o,k){var p=o.width()-1;var m=a.extend(true,[],k);var t=null;if(o.attr("data-pycs-done")!="true"){for(var l=0;l<m.length;l++){var j=parseInt(a(m[l]).width());var q=parseInt(a(m[l]).height());if(!a(m[l]).attr("data-pycs-width")){a(m[l]).attr("data-pycs-width",j)}if(!a(m[l]).attr("data-pycs-height")){a(m[l]).attr("data-pycs-height",q)}}}t=c(p,m);for(var h in t){for(var l in t[h]){var s=t[h][l];a(s).css({margin:parseInt(d.gutter/2)+"px","float":"left",position:"relative",width:a(s).attr("data-pycs-vwidth")+"px",height:a(s).attr("data-pycs-vheight")+"px",opacity:1});a("img",s).css({width:a(s).attr("data-pycs-vwidth")+"px",height:a(s).attr("data-pycs-vheight")+"px","margin-top":"0px",});o.append(a(s))}}o.attr("data-pycs-done","true")};var e=a(this);if(a(this).length>0){a(this).each(function(){f(a(this),a(d.pictureContainer,a(this)))});var g;window.onresize=function(){clearTimeout(g);g=setTimeout(function(){e.each(function(){f(a(this),a(d.pictureContainer,a(this)))})},100)}}return e}}(jQuery));